<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World</title>
</head>

<script src="pixi.js"></script>
<script src="tink.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.13/howler.js"></script>

<body>
<script type="text/javascript">


  let type = "WebGL";
  if(!PIXI.utils.isWebGLSupported()){
    type = "canvas";
  }

  PIXI.utils.sayHello(type);

  let Application = PIXI.Application,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    Sprite = PIXI.Sprite,
    Graphics = PIXI.Graphics,
    Text = PIXI.Text,
    TextStyle = PIXI.TextStyle,
    TextureCache = PIXI.TextureCache,
    Rectangle = PIXI.Rectangle,
    Container = PIXI.Container;

  let app = new Application({
    width: 1024,
    height: 768,
    antialias: true,
    transparent: false,
    resolution: 1
  });

  document.body.appendChild(app.view);
  app.renderer.backgroundColor = 0x99999999;
  let t = new Tink(PIXI, app.renderer.view);

  loader
    .add("images/cat.png")
    .add('images/quarter-note.png')
    .add('images/eighth-note.png')
    .add('images/staff.png')
    .add('images/hack_drum.png')
    .add('images/introscreen.png')
    .add('images/hack_ava_intro.png')
    .add('images/hack_ava_01.png')
    .add('images/hack_ava_02.png')
    .load(setup);

  let state, cat, startButton, introText, introPage, introTextStyle, outroText, quarter;
  let introAvatar, playingAvatarUp, playingAvatarDown;

  let musicPlaybackArea, musicPlaybackFrame, musicPlaybackStartButton;
  let musicTimer;
  let playingDrum, goodBeats = 0, badBeats = 0;
  let song;

  let noteWindow = 0;
  let drumSound = new Howl({src: 'platesnr.wav'});

  //let measure0 = [];
  let measures = [];
  let measure0; // = new Measure();
  let measure1 = [];

  function setup () {
    musicPlaybackArea = new Container();
    musicPlaybackArea.position.set(150, 600);
    musicPlaybackArea.visible = false;
    app.stage.addChild(musicPlaybackArea);

    cat = new Sprite(resources['images/cat.png'].texture);
    cat.anchor.set(0.5);
    cat.x = app.screen.width / 2;
    cat.y = app.screen.height / 2;
    cat.vx = 0;
    cat.vy = 0;
    app.stage.addChild(cat);

    measures = [];
    measures.push(new Measure(10));
    measures.push(new Measure(10+250));
    //measure0 = new Measure();


    quarter = setupNote("quarter");
    eighth = setupNote("eighth",60);

    introTextStyle = new TextStyle({
      fontFamily: 'Arial',
      fontSize: 36,
      fill: 'white',
      stroke: '#ff3300',
      strokeThickness: 4,
      dropShadow: true,
      dropShadowColor: '#000000',
      dropShadowBlur: 4,
      dropShadowAngle: Math.PI / 6,
      dropShadowDistance: 6
    });

    introText = new Text('Beat It', introTextStyle);
    introText.x = 20;
    introText.y = 3;
    app.stage.addChild(introText);

    outroText = new Text("Great job! Way to Beat It!", introTextStyle);
    outroText.x = 300;
    outroText.y = 30;
    app.stage.addChild(outroText);
    outroText.visible = false;

    startButton = new Graphics();
    startButton.lineStyle(4, 0xFF3300, 1);
    startButton.beginFill(0x66CCFF);
    startButton.drawRect(0, 0, 64, 64);
    startButton.endFill();
    startButton.x = 500;
    startButton.y = app.screen.width / 3 * 2;
    app.stage.addChild(startButton);

    startButton.interactive = true;
    startButton.buttonMode = true;
    startButton.visible = false;
    startButton.on('click',  () => state = math);



    musicPlaybackFrame = new Graphics();
    musicPlaybackFrame.lineStyle(4, 0xFF3300, 1);
    musicPlaybackFrame.beginFill(0xFFFFFF);
    musicPlaybackFrame.drawRect(0, 0, 800, 100);
    musicPlaybackFrame.endFill();
    musicPlaybackArea.addChild(musicPlaybackFrame);
    //musicPlaybackFrame.x = 150;
    //musicPlaybackFrame.y = 600;
    //musicPlaybackFrame.visible = false;

    musicPlaybackStartButton = new Graphics();
    musicPlaybackStartButton.lineStyle(4, 0xFF3300, 1);
    musicPlaybackStartButton.beginFill(0x66CCFF);
    musicPlaybackStartButton.drawRect(0, 0, 64, 64);
    musicPlaybackStartButton.endFill();
    app.stage.addChild(musicPlaybackStartButton);
    musicPlaybackStartButton.x = 800;
    musicPlaybackStartButton.y = 400;
    musicPlaybackStartButton.visible = false;
    musicPlaybackStartButton.interactive = true;
    musicPlaybackStartButton.buttonMode = true;
    musicPlaybackStartButton.on('click', checkMeasures); //() => state = playingMusic);

    playingDrum = new Sprite(resources['images/hack_drum.png'].texture);
    playingDrum.position.set(500, 400);
    playingDrum.width = 100;
    playingDrum.height = 100;
    playingDrum.visible = false;
    app.stage.addChild(playingDrum);

    playingAvatarUp = new Sprite(resources['images/hack_ava_01.png'].texture);
    playingAvatarDown = new Sprite(resources['images/hack_ava_02.png'].texture);
    playingAvatarUp.position.set(500, 300);
    playingAvatarDown.position.set(500, 300);
    playingAvatarUp.height = playingAvatarDown.height = 300;
    playingAvatarUp.width = playingAvatarDown.width = 300;
    app.stage.addChild(playingAvatarUp);
    app.stage.addChild(playingAvatarDown);
    playingAvatarUp.visible = playingAvatarDown.visible = false;

    introAvatar = new Sprite(resources['images/hack_ava_intro.png'].texture);
    introAvatar.position.set(500, 300);
    introAvatar.height = 200;
    introAvatar.width = 130;
    app.stage.addChild(introAvatar);
    introAvatar.visible = false;

    introPage = new Sprite(resources['images/introscreen.png'].texture);
    introPage.position.set(0, 0);
    introPage.width = 1024;
    introPage.height = 768;
    app.stage.addChild(introPage);

    state = introTransition;
    //state = setupMusic;

    app.ticker.add(delta => gameLoop(delta));

  }

  class Measure {

    constructor(x=10) {
      this.x = x;
      this.notes = [];
      let texture = TextureCache["images/staff.png"];
      let rect = new Rectangle(80,50,320,100);
      texture.frame = rect;
      this.sprite = new Sprite(texture);
      this.sprite.x = x;
      this.sprite.y = 100;
      this.sprite.vx = 0;
      this.sprite.vy = 0;
      this.sprite.width = 240;
      this.sprite.height = 120;
      app.stage.addChild(this.sprite);
    }
    addNote(noteType) {
      let xDrop = this.x + 68 + this.notes.length * 15;
      note = makeNote(noteType,xDrop,150);
      this.notes.push(note);
    }
    checkDrop(noteSprite,noteType) {
      if (hitTestRectangle(noteSprite, this.sprite)) {
        console.log("hit staff");
        this.addNote(noteType);
      }
    }
    checkMeasure() {
      let sum = 0.0;
      this.notes.forEach((note) => sum += note.value );
      if (sum == 1.0) {
        state = playingMusic;
      }
      else if (sum > 1.0) {
        alert("Your measures have too many notes (reload page)");
      }
      else {
        alert("Your measures do not have enough notes")
      }
    }
  }

  function checkMeasures() {
    let ok = false;
    measures.forEach( (ms) => (ok = ms.checkMeasure()) );

  }

  function setupNote(noteType, x=80, y=40) {
    note = makeNote(noteType,x,y);
    noteSprite = note.dragSprite;
    noteSprite.press = () => {
      noteDrag = makeNote(noteType,x);
      noteDrag.makeDraggable();
      noteDragSprite = noteDrag.dragSprite
      noteDragSprite.release = () => {
        console.log("release of drag")
        // rect intersection - todo need to loop thru all measures
        measures.forEach((ms) => ms.checkDrop(noteDragSprite,noteType));
        // if (hitTestRectangle(noteDragSprite, measure0.sprite)) {
        //   console.log("hit staff");
        //   measure0.addNote(noteType);
        // }
        // //
        noteDragSprite.visible = false; // hide the dragger
        //t.noteDragSprite
        // this cases exception with no children hmmm
        //app.stage.removeChild(noteDragSprite);
      };
    };

  }

  function makeNote(noteType, x=80, y=40) {
    return new Note(noteType, true, x, y);
  }

  function hitTestRectangle(r1, r2) {

    //Define the variables we'll need to calculate
    let hit, combinedHalfWidths, combinedHalfHeights, vx, vy;

    //hit will determine whether there's a collision
    hit = false;

    //Find the center points of each sprite
    r1.centerX = r1.x + r1.width / 2;
    r1.centerY = r1.y + r1.height / 2;
    r2.centerX = r2.x + r2.width / 2;
    r2.centerY = r2.y + r2.height / 2;

    //Find the half-widths and half-heights of each sprite
    r1.halfWidth = r1.width / 2;
    r1.halfHeight = r1.height / 2;
    r2.halfWidth = r2.width / 2;
    r2.halfHeight = r2.height / 2;

    //Calculate the distance vector between the sprites
    vx = r1.centerX - r2.centerX;
    vy = r1.centerY - r2.centerY;

    //Figure out the combined half-widths and half-heights
    combinedHalfWidths = r1.halfWidth + r2.halfWidth;
    combinedHalfHeights = r1.halfHeight + r2.halfHeight;

    //Check for a collision on the x axis
    if (Math.abs(vx) < combinedHalfWidths) {

      //A collision might be occuring. Check for a collision on the y axis
      if (Math.abs(vy) < combinedHalfHeights) {

        //There's definitely a collision happening
        hit = true;
      } else {

        //There's no collision on the y axis
        hit = false;
      }
    } else {

      //There's no collision on the x axis
      hit = false;
    }

    //`hit` will be either `true` or `false`
    return hit;
  };

  // make it interactie!  t.makeInteractive(anySprite); anySprite.press

  function gameLoop (delta) {
    state(delta);
    t.update();
  }

  function introTransition (delta) {
    introPage.visible = true;
    introPage.interactive = true;
    introPage.buttonMode = true;
    introPage.on('click', () => {
      introPage.visible = false;
      state = setupMusic
    });
    introText.visible = true;
    startButton.visible = true;
    state = intro;
  }

  function intro (delta) {

  }

  function math (delta) {
    introPage.visible = false;
    introText.visible = false;
    startButton.visible = false;
    console.log('hi');

    // Calculate current math problem

    // Display prompt, draggable notes, drop zone
  }
  class Note {
    constructor (name,drag=false,x=80,y=40) {
      this.name = name;
      if (drag) { // this could be a subclass really DragNote
        this.dragSprite = new Sprite(resources['images/' + name + '-note.png'].texture);
        this.dragSprite.x = x;
        this.dragSprite.y = y;
        this.dragSprite.vx = 0;
        this.dragSprite.vy = 0;
        this.dragSprite.width = 15;
        this.dragSprite.height = 25;
        t.makeInteractive(this.dragSprite);

        app.stage.addChild(this.dragSprite);
        t.makeInteractive(this.dragSprite);
      }
      switch (name) {
        case 'rest':
          this.value = 1;
          this.duration = 1;
          break;
        case 'whole':
          this.value = 1;
          this.duration = 1;
          break;
        case 'half':
          this.value = 0.5;
          this.duration = 0.5;
          break;
        case 'quarter':
          this.value = 0.25;
          this.duration = 0.25;
          break;
        case 'eighth':
          this.value = 0.125;
          this.duration = 0.125;
          break;
        case 'sixteenth':
          this.value = 0.0625;
          this.duration = 0.0625;
          break;
        default:
          console.log('unknown note name', name);
      }
      this.img = makeNoteScrolling(this.duration);
    }

    makeDraggable() {
      t.makeDraggable(this.dragSprite);
    }
  }

  function setupMusic () {
    introText.visible = false;
    cat.visible = false;
    introAvatar.visible = true;
    playingDrum.visible = false;
    // Representation of song?
    // Array of measures
    // Each measure is an array of notes, the time values for which sum to 1.

    //let measure0 = [new Note('rest')]; - defined by dragging now!
    //let measure1 = [new Note('half'), new Note('quarter'), new Note('quarter')];
    let measure2 = [new Note('eighth'), new Note('sixteenth'), new Note('sixteenth'), new Note('half'), new Note('quarter')];
    let measure3 = [new Note('sixteenth'), new Note('sixteenth'), new Note('sixteenth'), new Note('sixteenth'), new Note('half'), new Note('quarter')];
    song = [measure0, measure1, measure2, measure3];

    // Place animated music player person
    playingAvatarUp.interactive = true;
    playingAvatarUp.buttonMode = true;
    playingAvatarUp.on('mousedown', () => {
      drumSound.play();
      playingAvatarUp.visible = false;
      playingAvatarDown.visible = true;
      if (noteWindow > 0) {
        goodBeats += 1;
      } else {
        badBeats += 1;
      }
      noteWindow = 0;
    });
    playingAvatarUp.on('mouseup', () => {
      playingAvatarDown.visible = false;
      playingAvatarUp.visible = true;
    });

    // Place scrolling music display
    musicPlaybackArea.visible = true;


    // Place start button
    musicPlaybackStartButton.visible = true;
    musicTimer = 0;

    state = music;
  }

  function music (delta) {

    // When start button is pressed, begin music play
    //playingDrum.visible = true;

  }

  function playingMusic (delta) {
    musicPlaybackStartButton.visible = false;
    introAvatar.visible = false;
    playingAvatarUp.visible = true;

    noteWindow -= 1;

    if (measures.length === 0) {
      state = outroTransition;
      return;
    }
    // User taps screen in time with selected notes, accuracy is counted

    // Draw notes on bottom, scrolling towards the left
    for (let measure of measures) {
      // put notes
      for (let note of measure.notes) {
        note.img.x += note.img.vx;
        if (note.img.x < 800) {
          note.img.visible = true;
        }
      }
    }

    if (measures[0].notes[0].img.x <= 50) {
      noteWindow = 20;
    }

    if (measures[0].notes[0].img.x <= 0) {
      measures[0].notes[0].img.visible = false;
      console.log('playing note', measures[0].notes[0].name);
      //song[0].shift();
      measures[0].notes.shift();

      // New note! Play a sound
      //drumSound.play();

      // Next measure
      if (measures[0].notes.length === 0) {
        //song.shift();
        measures.shift();
      }
    }

  }

  function outroTransition (delta) {
    console.log('in outro');
    musicPlaybackArea.visible = false;
    cat.visible = false;
    outroText.visible = true;


    let resultText = new Text(`You had ${goodBeats} good beats and ${badBeats} bad beats!`, introTextStyle);
    resultText.x = 300;
    resultText.y = 100;
    app.stage.addChild(resultText);

    state = outro
  }

  function outro () {

  }


  let accumulatedDuration = 800;

  function makeNoteScrolling(duration) {
    let note = new Sprite(resources['images/quarter-note.png'].texture);
    note.anchor.set(0.5);
    note.x = accumulatedDuration;
    note.y = 50;
    note.vx = -3;
    note.vy = 0;
    note.width = 30;
    note.height = 50;
    note.visible = false;
    musicPlaybackArea.addChild(note);
    accumulatedDuration += duration * 100 * 4;
    return note;
  }

</script>
</body>
</html>
